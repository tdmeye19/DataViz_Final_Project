---
title: "Data_Tidying"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rvest)
library(tidyverse)
library(zoo)
library(emphatic)

url <- "https://www.espn.com/soccer/table/_/league/usa.1"

## convert the html code into something R can read
h <- read_html(url)

## grabs the tables
tab <- h %>% html_nodes("table")

test1 <- tab[[1]] %>% html_table()
test2 <- tab[[2]] %>% html_table()

statsfull <- bind_cols(test1, test2)

test1 <- test1 %>% slice(-1, -15)

statsfull <- statsfull %>% rename("club" = X1...1, "GP" = X1...2, 
                                      "Wins" = X2 , "Draws" = X3 ,
                                      "Losses" = X4 , "Goals For" = X5,
                                      "Goals Against" = X6, "Goal Differential" = X7,
                                      "Points" =  X8)

statsfull <- statsfull %>% slice(-1, -16)

statsfull <- statsfull %>% arrange(desc(Points))

statsfull <- statsfull %>% 
  mutate(Seed = parse_number(club)) %>%
  mutate(newclub = str_remove(club, pattern = "[[:digit:]]+"))

statsfull <- statsfull %>% 
  mutate(newclub2 = fct_recode(newclub, 
                               `New England Revolution` = "NENew England Revolution",
                               `Seattle Sounders FC` = "SEASeattle Sounders FC",
                               `Sporting Kansas City` = "SKCSporting Kansas City",
                               `Colorado Rapids` = "COLColorado Rapids",
                               `Philadelphia Union` = "PHIPhiladelphia Union",
                               `Nashville SC` = "NSHNashville SC",
                               `New York City FC` = "NYCNew York City FC",
                               `Portland Timbers` = "PORPortland Timbers",
                               `Orlando City SC` = "ORLOrlando City SC",
                               `Minnesota United FC` = "MINMinnesota United FC",
                               `Atlanta United FC` = "ATLAtlanta United FC",
                               `LA Galaxy` = "LALA Galaxy",
                               `Vancouver Whitecaps` = "VANVancouver Whitecaps",
                               `New York Red Bulls` = "NYNew York Red Bulls",
                               `Real Salt Lake` = "RSLReal Salt Lake",
                               `D.C. United` = "DCD.C. United",
                               `Columbus Crew` = "CLBColumbus Crew",
                               `LAFC` = "LAFCLAFC",
                               `CF Montréal` = "MTLCF Montréal",
                               `San Jose Earthquakes` = "SJSan Jose Earthquakes",
                               `Inter Miami CF` = "MIAInter Miami CF",
                               `Chicago Fire FC` = "CHIChicago Fire FC",
                               `FC Dallas` = "DALFC Dallas",
                               `Houston Dynamo FC` = "HOUHouston Dynamo FC",
                               `Toronto FC` = "TORToronto FC",
                               `Austin FC` = "ATXAustin FC",
                               `FC Cincinnati` = "CINFC Cincinnati",
                               `Charlotte FC` = "CLTCharlotte FC"))

statsfull <- statsfull %>% select(-club, -newclub)

statsfull <- statsfull %>% select(Seed, newclub2, Points, GP, everything())

statsfull$Points

statsfull <- statsfull %>% mutate(Points = as.numeric(Points),
                                  `Goal Differential` = as.numeric(`Goal Differential`),
                                  GP = as.numeric(GP),
                                  Wins = as.numeric(Wins),
                                  Draws = as.numeric(Draws),
                                  Losses = as.numeric(Losses),
                                  `Goals For` = as.numeric(`Goals For`),
                                  `Goals Against` = as.numeric(`Goals Against`)) 

statsfull <- statsfull %>% arrange(desc(Points)) %>%
  mutate(newclub2 = fct_reorder(newclub2, Points),
         Conference = c(0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1),
         PPG = Points / GP) 
  
statsfull <- statsfull %>% mutate(Conference = if_else(Conference == 0,
                                            true = "East",
                                            false = "West"))

ggplot(data = statsfull, aes(x = newclub2, y = Points)) +
  geom_point() +
  coord_flip()

ggplot(data = statsfull, aes(x = newclub2, y = `Goal Differential`)) +
  geom_point() +
  coord_flip()

ggplot(data = statsfull, aes(x = Conference, y = Points)) +
  geom_boxplot()

ggplot(data = statsfull, aes(x = `Goals For`, y = Points, colour = Conference)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE)

ggplot(data = statsfull, aes(x = PPG, y = Seed, colour = Conference)) +
  geom_point()

statsfull %>% hl(colour = "green", rows = 1)
```

```{r}
library(rvest)
library(tidyverse)
library(zoo)

url2 <- "https://www.espn.com/soccer/stats/_/league/usa.1"

## convert the html code into something R can read
h2 <- read_html(url2)

## grabs the tables
gatab <- h2 %>% html_nodes("table")

goal_leaders <- gatab[[1]] %>% html_table()
assist_leaders <- gatab[[2]] %>% html_table()

goal_leaders <- goal_leaders %>%
  rename("Rank" = RK,
         "Player" = Name,
         "Club" = Team,
         "GP" = P,
         "Goals" = G)

assist_leaders <- assist_leaders %>%
  rename("Rank" = RK,
         "Player" = Name,
         "Club" = Team,
         "GP" = P,
         "Assists" = A)

tibble(Rank = c(1, NA, NA, NA, 5, NA, NA, NA))

assist_leaders <- assist_leaders %>% mutate(newrank = na.locf(Rank))

goal_leaders <- goal_leaders %>% mutate(newrank = na.locf(Rank))
```

```{r}
library(rvest)
library(tidyverse)

url3 <- "https://www.transfermarkt.us/major-league-soccer/marktwerteverein/wettbewerb/MLS1/plus/?stichtag=2021-03-15"

## convert the html code into something R can read
h3 <- read_html(url3)

## grabs the tables
valuetab <- h3 %>% html_nodes("table")

valuetest <- valuetab[[1]] %>% html_table()
valuetest2 <- valuetab[[2]] %>% html_table()
valuetest3 <- valuetab[[3]] %>% html_table()
value_df <- valuetab[[4]] %>% html_table()

value_df <- value_df %>% select(1, 3, 5, 6, 7) %>%
  slice(-1)

value_df <- value_df %>% rename("Value_2021" = League,
                                "Value_2022" = `Value Mar 15, 2021`,
                                "Difference" = `Current value`)

value_df <- value_df %>% mutate(Value_2021 = parse_number(`Value_2021`),
                                Value_2022 = parse_number(`Value_2022`),
                                Difference = parse_number(Difference))

value_df <- value_df %>% mutate(Value_2021 = if_else(Value_2021 > 100,
                                         true = Value_2021 / 1000,
                                         false = Value_2021))

value_df <- value_df %>% mutate(diffind = if_else(Difference < 0,
                                      true = "Decrease",
                                      false = "Increase"))

ggplot(data = value_df, aes(x = Value_2021, y = Value_2022, colour = diffind)) +
  geom_point()
```

```{r}
library(rvest)
library(tidyverse)

url4 <- "https://www.transfermarkt.us/major-league-soccer/besucherzahlen/wettbewerb/MLS1/saison_id/2021/plus/1"

## convert the html code into something R can read
h4 <- read_html(url4)

## grabs the tables
attendancetab <- h4 %>% html_nodes("table")

attendancetest <- attendancetab[[1]] %>% html_table()
attendancetest2 <- attendancetab[[2]] %>% html_table()
attendancetest3 <- attendancetab[[3]] %>% html_table()
attendance_df <- attendancetab[[4]] %>% html_table()

#attendance_df %>% slice(2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35, 38, 41, 44, 47, 50, 53, 56, 59, 62, 65, 68, 71, 74)
```

